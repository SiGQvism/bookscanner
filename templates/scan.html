<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ISBNã‚¹ã‚­ãƒ£ãƒŠ</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/static/isbn192.png">
<meta name="theme-color" content="#000">
<style>
 body{margin:0;font-family:sans-serif;background:#000;color:#fff;
       display:flex;flex-direction:column;align-items:center}
 h1{margin:1rem 0 .5rem;font-size:2rem;color:#d8aaff}
 #video-wrapper{position:relative;width:90%;max-width:500px;height:220px;margin-top:1rem}
 video{width:100%;height:100%;object-fit:contain;border:3px solid #d8aaff;border-radius:12px}
 #status{margin-top:1rem;font-size:1.2rem;font-weight:bold;text-align:center}
 #book-info{margin-top:1rem;width:90%;max-width:600px;background:#111;border-radius:8px;padding:1rem}
 #rescan{margin:1.5rem auto;padding:.6rem 1.4rem;border:none;border-radius:6px;
         background:#8b508d;color:#fff;font-size:1rem;display:none;cursor:pointer}
 textarea{width:90%;max-width:600px;margin-top:1rem;padding:.5rem;border-radius:6px}
</style>
</head>
<body>
<h1>ğŸ“· ISBN ã‚¹ã‚­ãƒ£ãƒŠ</h1>

<div id="video-wrapper">
  <video id="video" playsinline></video>
</div>

<div id="status">ğŸ“– ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­â€¦</div>
<div id="book-info"></div>

<label style="width:90%;max-width:600px;display:block">
  ğŸ“ æ›¸è©•ï¼ˆä»»æ„ï¼‰:
  <textarea id="review" rows="3"></textarea>
</label>

<button id="rescan">ğŸ”„ å†ã‚¹ã‚­ãƒ£ãƒ³</button>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>

<script>
/* ---- OpenCV.js åˆæœŸåŒ– ---- */
let cvReady = false;
Module = { onRuntimeInitialized() { cvReady = true; console.log("âœ… OpenCV ready"); } };

/* ---- DOM å–å¾— ---- */
const ZX        = ZXing;
const videoEl   = document.getElementById("video");
const statusEl  = document.getElementById("status");
const infoBox   = document.getElementById("book-info");
const reviewEl  = document.getElementById("review");
const rescanBtn = document.getElementById("rescan");

/* ---- ZXing Readerï¼ˆsetHints ã¯å»ƒæ­¢ï¼‰ ---- */
const reader = new ZX.BrowserMultiFormatReader({ delayBetweenScanAttempts: 200 });

/* ---- Canvasï¼ˆãƒ¡ãƒ¢ãƒªä¸Šï¼‰ ---- */
const cvs = document.createElement("canvas");
const ctx = cvs.getContext("2d");

/* ---- ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ ---- */
let stream   = null;
let scanning = false;
let lastISBN = null;

/* ================================================================= */
/*  ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚’å–å¾—ã—ãŸã¨ãã«å‘¼ã°ã‚Œã‚‹å‡¦ç†                         */
/* ================================================================= */
async function onDetect(isbn) {
  console.log("âœ… DETECT:", isbn);
  statusEl.textContent = "ğŸ“š æ›¸ç±æƒ…å ±å–å¾—ä¸­â€¦";

  const token = localStorage.getItem("notionToken");
  const dbid  = localStorage.getItem("notionDbId");
  const review= reviewEl.value.trim();

  try {
    const res  = await fetch(`/add/${isbn}`, {
      method: "POST",
      headers: {
        "Content-Type":  "application/json",
        "Authorization": `Bearer ${token}`,
        "X-Database-ID": dbid
      },
      body: JSON.stringify({ review })
    });
    const data = await res.json();

    if (data.status === "OK") {
      infoBox.innerHTML = `
        ${data.cover ? `<img id="cover-img" src="${data.cover}" alt="æ›¸å½±">` : ""}
        <ul>
          <li><strong>ğŸ“• æ›¸å:</strong> ${data.title || "æƒ…å ±ãªã—"}</li>
          <li><strong>âœï¸ è‘—è€…:</strong> ${data.author || "æƒ…å ±ãªã—"}</li>
          <li><strong>ğŸ¢ å‡ºç‰ˆç¤¾:</strong> ${data.publisher || "æƒ…å ±ãªã—"}</li>
          <li><strong>ğŸ’´ å€¤æ®µ:</strong> ${data.price ? data.price + " å††" : "æƒ…å ±ãªã—"}</li>
          <li><strong>ğŸ“… å‡ºç‰ˆæ—¥:</strong> ${data.pub_date || "æƒ…å ±ãªã—"}</li>
          <li><strong>ğŸ“„ ãƒšãƒ¼ã‚¸æ•°:</strong> ${data.pages || "æƒ…å ±ãªã—"}</li>
          <li><strong>ğŸ“– è¦ç´„:</strong> ${data.summary || "æƒ…å ±ãªã—"}</li>
        </ul>`;
      statusEl.textContent = "âœ… ç™»éŒ²å®Œäº†";
    } else {
      statusEl.textContent = "âš ï¸ " + data.message;
    }
  } catch (e) {
    console.error(e);
    statusEl.textContent = "âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼";
  }

  rescanBtn.style.display = "block";
}

/* ================================================================= */
/*  1 ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã« ROI ã‚’åˆ‡ã‚Šå‡ºã—ã¦ ZXing ã¸æ¸¡ã™                    */
/* ================================================================= */
function tick() {
  if (!scanning || !cvReady) return requestAnimationFrame(tick);

  cvs.width  = videoEl.videoWidth;
  cvs.height = videoEl.videoHeight;
  ctx.drawImage(videoEl, 0, 0, cvs.width, cvs.height);

  // ROI è¨ˆç®—ï¼ˆä¾‹ï¼šä¸­å¤® 50% ã‚’èª­ã‚€ï¼‰
  const rw = cvs.width  * 0.5 | 0;
  const rh = cvs.height * 0.3 | 0;
  const rx = (cvs.width  - rw) / 2 | 0;
  const ry = (cvs.height - rh) / 2 | 0;

  const roi = ctx.getImageData(rx, ry, rw, rh);

  // off-screen canvas ã¸æç”»ã— ZXing ã¸
  const tmp = document.createElement("canvas");
  tmp.width = rw; tmp.height = rh;
  tmp.getContext("2d").putImageData(roi, 0, 0);

  reader
    .decodeFromImage(tmp)
    .then(res => {
      if (res && res.text && res.text !== lastISBN) {
        lastISBN = res.text;
        onDetect(res.text);
      }
    })
    .catch(() => { /* èª­ã‚ãªã„ãƒ•ãƒ¬ãƒ¼ãƒ ã¯ç„¡è¦– */ });

  requestAnimationFrame(tick);
}

/* ================================================================= */
/*  ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’ video è¦ç´ ã¸                         */
/* ================================================================= */
async function startCamera() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  infoBox.innerHTML = ""; reviewEl.value = ""; statusEl.textContent = "ğŸ“– ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­â€¦";
  rescanBtn.style.display = "none"; lastISBN = null;

  const constraints = { video: { facingMode: { ideal: "environment" }, width:{ideal:1280} }, audio:false };
  try {
    stream = await navigator.mediaDevices.getUserMedia(constraints);
  } catch {
    constraints.video.facingMode = "user";
    stream = await navigator.mediaDevices.getUserMedia(constraints);
  }

  videoEl.srcObject = stream;
  await videoEl.play();

  scanning = true;
  requestAnimationFrame(tick);
}

/* ================================================================= */
/*  ã‚¤ãƒ™ãƒ³ãƒˆ                                                           */
/* ================================================================= */
rescanBtn.addEventListener("click", startCamera);
window.addEventListener("load", startCamera);
</script>
