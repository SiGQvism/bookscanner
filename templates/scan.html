<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ISBNã‚¹ã‚­ãƒ£ãƒŠ</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/static/isbn192.png" />
  <meta name="theme-color" content="#000" />
  <style>
    /* ---------- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ---------- */
    body{
      margin:0;
      font-family:sans-serif;
      background:#000;
      color:#fff;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    h1{
      margin:1rem 0 .5rem;
      font-size:2rem;
      color:#d8aaff;
    }

    /* â˜… æ¨ªé•·ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç”¨ãƒ“ãƒ‡ã‚ªæ  (é«˜ã•120px) */
    #video-wrapper{
      position:relative;
      width:90%;
      max-width:500px;
      height:120px;
      margin-top:1rem;
    }
    video{
      width:100%;
      height:100%;
      object-fit:cover;
      border:3px solid #d8aaff;
      border-radius:12px;
      box-shadow:0 0 15px rgba(255,192,255,.3);
    }

    #status{margin-top:1rem;font-size:1.2rem;font-weight:bold;text-align:center}
    #book-info{margin-top:1rem;width:90%;max-width:600px;background:#111;
               border-radius:8px;padding:1rem}
    #rescan{margin:1.5rem auto;padding:.6rem 1.4rem;border:none;border-radius:6px;
            background:#8b508d;color:#fff;font-size:1rem;display:none;cursor:pointer}
    textarea{width:90%;max-width:600px;margin-top:1rem;padding:.5rem;border-radius:6px}
  </style>
</head>
<body>
  <h1>ğŸ“· ISBN ã‚¹ã‚­ãƒ£ãƒŠ</h1>

  <div id="video-wrapper">
    <video id="video" playsinline autoplay></video>
  </div>

  <div id="status">ğŸ“– ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­â€¦</div>
  <div id="book-info"></div>

  <label style="width:90%;max-width:600px;display:block">
    ğŸ“ æ›¸è©•ï¼ˆä»»æ„ï¼‰:
    <textarea id="review" rows="3"></textarea>
  </label>

  <button id="rescan">ğŸ”„ å†ã‚¹ã‚­ãƒ£ãƒ³</button>

  <!-- ZXing -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <script>
    /* ---------- DOM å‚ç…§ ---------- */
    const ZX        = ZXing;
    const videoEl   = document.getElementById('video');
    const statusEl  = document.getElementById('status');
    const infoBox   = document.getElementById('book-info');
    const reviewEl  = document.getElementById('review');
    const btnRescan = document.getElementById('rescan');

    /* ---------- ZXing ãƒªãƒ¼ãƒ€ãƒ¼ ---------- */
    const reader = new ZX.BrowserMultiFormatReader({ delayBetweenScanAttempts:250 });
    const hints  = new Map();
    hints.set(ZX.DecodeHintType.TRY_HARDER, true);   // èªè­˜ç²¾åº¦ã‚’ä¸Šã’ã‚‹
    reader.setHints(hints);

    let stream   = null;
    let lastISBN = null;

    /* ---------- æ›¸ç±ç™»éŒ²å‡¦ç† ---------- */
    async function onDetect(isbn){
      console.log('âœ… DETECT:', isbn);
      statusEl.textContent = 'ğŸ“š æ›¸ç±æƒ…å ±å–å¾—ä¸­â€¦';

      const token = localStorage.getItem('notionToken');
      const dbid  = localStorage.getItem('notionDbId');
      const review= reviewEl.value.trim();

      try{
        const res  = await fetch(`/add/${isbn}`,{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization':`Bearer ${token}`,
            'X-Database-ID':dbid
          },
          body: JSON.stringify({ review })
        });
        const data = await res.json();
        if(data.status==='OK'){
          infoBox.innerHTML = `
            ${data.cover ? `<img id="cover-img" src="${data.cover}" alt="æ›¸å½±">` : ''}
            <ul>
              <li><strong>ğŸ“• æ›¸å:</strong> ${data.title||'æƒ…å ±ãªã—'}</li>
              <li><strong>âœï¸ è‘—è€…:</strong> ${data.author||'æƒ…å ±ãªã—'}</li>
              <li><strong>ğŸ¢ å‡ºç‰ˆç¤¾:</strong> ${data.publisher||'æƒ…å ±ãªã—'}</li>
              <li><strong>ğŸ’´ å€¤æ®µ:</strong> ${data.price?data.price+' å††':'æƒ…å ±ãªã—'}</li>
              <li><strong>ğŸ“… å‡ºç‰ˆæ—¥:</strong> ${data.pub_date||'æƒ…å ±ãªã—'}</li>
              <li><strong>ğŸ“„ ãƒšãƒ¼ã‚¸æ•°:</strong> ${data.pages||'æƒ…å ±ãªã—'}</li>
              <li><strong>ğŸ“– è¦ç´„:</strong> ${data.summary||'æƒ…å ±ãªã—'}</li>
            </ul>`;
          statusEl.textContent = 'âœ… ç™»éŒ²å®Œäº†';
        }else{
          statusEl.textContent = 'âš ï¸ ' + data.message;
        }
      }catch(e){
        console.error(e);
        statusEl.textContent = 'âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼';
      }
      btnRescan.style.display = 'block';
    }

    /* ---------- ã‚«ãƒ¡ãƒ©èµ·å‹• ---------- */
    async function startCamera(){
      // æ—¢å­˜ã‚¹ãƒˆãƒªãƒ¼ãƒ åœæ­¢
      if(stream) stream.getTracks().forEach(t=>t.stop());
      infoBox.innerHTML = '';
      reviewEl.value    = '';
      statusEl.textContent = 'ğŸ“– ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­â€¦';
      btnRescan.style.display = 'none';
      lastISBN = null;

      // ãƒ‡ãƒã‚¤ã‚¹åˆ—æŒ™ã—ã¦èƒŒé¢ã‚’å„ªå…ˆ
      const devices = await ZX.BrowserCodeReader.listVideoInputDevices();
      const backCam = devices.find(d=>/back|rear|ç’°å¢ƒ|èƒŒé¢/i.test(d.label));
      const deviceId= backCam ? backCam.deviceId : devices[0]?.deviceId;

      /* é«˜è§£åƒåº¦ã‚’å¸Œæœ›ï¼ˆç«¯æœ«ãŒè¨±ã›ã° 1280Ã—720 ä»¥ä¸Šã§å–å¾—ï¼‰ */
      const constraints = {
        video:{
          deviceId: deviceId ? {exact:deviceId}:undefined,
          facingMode:'environment',
          width : {ideal:1280},
          height: {ideal:720}
        },
        audio:false
      };

      try{
        stream = await navigator.mediaDevices.getUserMedia(constraints);
      }catch(e){
        console.warn('èƒŒé¢ã‚«ãƒ¡ãƒ©å¤±æ•—â†’å†…ã‚«ãƒ¡ãƒ©', e);
        constraints.video.facingMode = 'user';
        stream = await navigator.mediaDevices.getUserMedia(constraints);
      }

      videoEl.srcObject = stream;
      await videoEl.play();

      /* ZXing ã§é€£ç¶šãƒ‡ã‚³ãƒ¼ãƒ‰ */
      reader.decodeFromVideoDevice(deviceId, videoEl, (result, err, ctrl)=>{
        if(result && result.text !== lastISBN){
          lastISBN = result.text;
          ctrl.stop();           // èª­ã¿å–ã‚ŒãŸã‚‰ä¸€æ—¦åœæ­¢
          onDetect(result.text);
        }
      });
    }

    /* ---------- ã‚¤ãƒ™ãƒ³ãƒˆ ---------- */
    btnRescan.addEventListener('click', startCamera);
    window.addEventListener('load', startCamera);
  </script>
</body>
</html>
