<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ISBNã‚¹ã‚­ãƒ£ãƒŠ</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/static/isbn192.png">
<meta name="theme-color" content="#000">
<style>
 body{margin:0;font-family:sans-serif;background:#000;color:#fff;
       display:flex;flex-direction:column;align-items:center}
 h1{margin:1rem 0 .5rem;font-size:2rem;color:#d8aaff}
 #video-wrapper{position:relative;width:90%;max-width:500px;height:220px;margin-top:1rem}
 video{width:100%;height:100%;object-fit:contain;border:3px solid #d8aaff;border-radius:12px}
 #status{margin-top:1rem;font-size:1.2rem;font-weight:bold;text-align:center}
 #book-info{margin-top:1rem;width:90%;max-width:600px;background:#111;border-radius:8px;padding:1rem}
 #rescan{margin:1.5rem auto;padding:.6rem 1.4rem;border:none;border-radius:6px;
         background:#8b508d;color:#fff;font-size:1rem;display:none;cursor:pointer}
 textarea{width:90%;max-width:600px;margin-top:1rem;padding:.5rem;border-radius:6px}
</style>
</head>
<body>
<h1>ğŸ“· ISBN ã‚¹ã‚­ãƒ£ãƒŠ</h1>

<div id="video-wrapper">
  <video id="video" playsinline></video>
</div>

<div id="status">ğŸ“– ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­â€¦</div>
<div id="book-info"></div>

<label style="width:90%;max-width:600px;display:block">
  ğŸ“ æ›¸è©•ï¼ˆä»»æ„ï¼‰:
  <textarea id="review" rows="3"></textarea>
</label>

<button id="rescan">ğŸ”„ å†ã‚¹ã‚­ãƒ£ãƒ³</button>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
const ZX=ZXing;
const video=document.getElementById('video');
const statusEl=document.getElementById('status');
const info=document.getElementById('book-info');
const review=document.getElementById('review');
const btn=document.getElementById('rescan');

const reader=new ZX.BrowserMultiFormatReader({delayBetweenScanAttempts:200});
let stream,lastISBN=null;

/* å–å¾—ã—ãŸ ISBN ã‚’ Notion ã¸é€ã‚‹ */
async function onDetect(isbn){
  console.log('âœ… DETECT',isbn);
  statusEl.textContent='ğŸ“š æ›¸ç±æƒ…å ±å–å¾—ä¸­â€¦';
  const token=localStorage.getItem('notionToken');
  const dbid =localStorage.getItem('notionDbId');
  try{
    const r=await fetch(`/add/${isbn}`,{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization':`Bearer ${token}`,
        'X-Database-ID':dbid
      },
      body:JSON.stringify({review:review.value.trim()})
    });
    const d=await r.json();
    if(d.status==='OK'){
      info.innerHTML=`
        ${d.cover?`<img src="${d.cover}" style="max-width:180px;margin:0 auto 1rem;display:block">`:''}
        <ul>
         <li><strong>ğŸ“• æ›¸å:</strong> ${d.title||'æƒ…å ±ãªã—'}</li>
         <li><strong>âœï¸ è‘—è€…:</strong> ${d.author||'æƒ…å ±ãªã—'}</li>
         <li><strong>ğŸ¢ å‡ºç‰ˆç¤¾:</strong> ${d.publisher||'æƒ…å ±ãªã—'}</li>
         <li><strong>ğŸ’´ å€¤æ®µ:</strong> ${d.price?d.price+' å††':'æƒ…å ±ãªã—'}</li>
         <li><strong>ğŸ“… å‡ºç‰ˆæ—¥:</strong> ${d.pub_date||'æƒ…å ±ãªã—'}</li>
         <li><strong>ğŸ“„ ãƒšãƒ¼ã‚¸æ•°:</strong> ${d.pages||'æƒ…å ±ãªã—'}</li>
         <li><strong>ğŸ“– è¦ç´„:</strong> ${d.summary||'æƒ…å ±ãªã—'}</li>
        </ul>`;
      statusEl.textContent='âœ… ç™»éŒ²å®Œäº†';
    }else{
      statusEl.textContent='âš ï¸ '+d.message;
    }
  }catch(e){
    console.error(e);statusEl.textContent='âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼';
  }
  btn.style.display='block';
}

/* ã‚«ãƒ¡ãƒ©èµ·å‹• & ãƒ‡ã‚³ãƒ¼ãƒ‰é–‹å§‹ */
async function startCamera(){
  // æ—§ã‚¹ãƒˆãƒªãƒ¼ãƒ åœæ­¢
  if(stream) stream.getTracks().forEach(t=>t.stop());
  info.innerHTML=''; review.value=''; btn.style.display='none';
  statusEl.textContent='ğŸ“– ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­â€¦'; lastISBN=null;

  /* 1. getUserMedia ã§è¨±å¯ã‚’ã‚‚ã‚‰ã†ï¼ˆèƒŒé¢â†’å†…ã‚«ãƒ¡ãƒ©ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ */
  const constraints  ={video:{facingMode:'environment'},audio:false};
  try{
    stream=await navigator.mediaDevices.getUserMedia(constraints);
  }catch{
    constraints.video.facingMode='user';
    stream=await navigator.mediaDevices.getUserMedia(constraints);
  }
  video.srcObject=stream; await video.play();

  /* 2. ZXing ã§ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼ˆvideo è¦ç´ ãã®ã‚‚ã®ã‚’è§£æï¼‰ */
  reader.decodeFromVideoElement(video,(res,err)=>{
      if(res && res.text!==lastISBN){
        lastISBN=res.text;
        reader.reset();      // é‡è¤‡å›é¿
        onDetect(res.text);
      }
      if(err && err.message) console.debug(err.message);
  });
}

btn.addEventListener('click',startCamera);
window.addEventListener('load',startCamera);
</script>
</body>
</html>
