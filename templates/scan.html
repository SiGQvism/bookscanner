<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ISBNã‚¹ã‚­ãƒ£ãƒŠ</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/static/isbn192.png">
<meta name="theme-color" content="#000">
<style>
 body{margin:0;font-family:sans-serif;background:#000;color:#fff;
       display:flex;flex-direction:column;align-items:center}
 h1{margin:1rem 0 .5rem;font-size:2rem;color:#d8aaff}
 #video-wrapper{position:relative;width:90%;max-width:500px;height:220px;margin-top:1rem}
 video{width:100%;height:100%;object-fit:contain;border:3px solid #d8aaff;border-radius:12px}
 #status{margin-top:1rem;font-size:1.2rem;font-weight:bold;text-align:center}
 #book-info{margin-top:1rem;width:90%;max-width:600px;background:#111;border-radius:8px;padding:1rem}
 #rescan{margin:1.5rem auto;padding:.6rem 1.4rem;border:none;border-radius:6px;
         background:#8b508d;color:#fff;font-size:1rem;display:none;cursor:pointer}
 textarea{width:90%;max-width:600px;margin-top:1rem;padding:.5rem;border-radius:6px}
</style>
</head>
<body>
<h1>ğŸ“· ISBN ã‚¹ã‚­ãƒ£ãƒŠ</h1>

<div id="video-wrapper">
  <video id="video" playsinline></video>
</div>

<div id="status">ğŸ“– ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­â€¦</div>
<div id="book-info"></div>

<label style="width:90%;max-width:600px;display:block">
  ğŸ“ æ›¸è©•ï¼ˆä»»æ„ï¼‰:
  <textarea id="review" rows="3"></textarea>
</label>

<button id="rescan">ğŸ”„ å†ã‚¹ã‚­ãƒ£ãƒ³</button>

<script type="module">
import {
  BrowserMultiFormatReader,
  DecodeHintType,
  BarcodeFormat,
} from "https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/+esm";

const ZX = { BrowserMultiFormatReader, DecodeHintType, BarcodeFormat };
const video  = document.getElementById("video");
const status = document.getElementById("status");

const reader = new ZX.BrowserMultiFormatReader(null, 250);  // â† setHints ä½¿ã‚ãš delay ç¬¬äºŒå¼•æ•°
reader.options = { tryHarder: true };                      // â† TRY_HARDER ç›¸å½“

/* ---------- ã‚«ãƒ¡ãƒ© ---------- */
async function startCamera() {
  const cons = { video: { facingMode: "environment" }, audio: false };
  const stream = await navigator.mediaDevices
    .getUserMedia(cons)
    .catch(() => navigator.mediaDevices.getUserMedia({ video: true }));
  video.srcObject = stream;
  await video.play();

  // ã“ã“ã§ã¯ ROI / OpenCV ã¯ã¾ã è§¦ã‚‰ãªã„
  reader.decodeFromVideoDevice(null, video, (result, err, ctrl) => {
    if (result) {
      ctrl.stop();               // 1 å›æ­¢ã‚ã¦â€¦
      status.textContent = "âœ… " + result.text;
    }
  });
}
window.addEventListener("load", startCamera);
</script>
