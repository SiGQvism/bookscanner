<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ISBNスキャナ</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/static/isbn192.png">
<meta name="theme-color" content="#000">
<style>
 body{margin:0;font-family:sans-serif;background:#000;color:#fff;
       display:flex;flex-direction:column;align-items:center}
 h1{margin:1rem 0 .5rem;font-size:2rem;color:#d8aaff}
 #video-wrapper{position:relative;width:90%;max-width:500px;height:220px;margin-top:1rem}
 video{width:100%;height:100%;object-fit:contain;border:3px solid #d8aaff;border-radius:12px}
 #status{margin-top:1rem;font-size:1.2rem;font-weight:bold;text-align:center}
 #book-info{margin-top:1rem;width:90%;max-width:600px;background:#111;border-radius:8px;padding:1rem}
 #rescan{margin:1.5rem auto;padding:.6rem 1.4rem;border:none;border-radius:6px;
         background:#8b508d;color:#fff;font-size:1rem;display:none;cursor:pointer}
 textarea{width:90%;max-width:600px;margin-top:1rem;padding:.5rem;border-radius:6px}
</style>
</head>
<body>
<h1>📷 ISBN スキャナ</h1>

<div id="video-wrapper">
  <video id="video" playsinline></video>
</div>

<div id="status">📖 スキャン待機中…</div>
<div id="book-info"></div>

<label style="width:90%;max-width:600px;display:block">
  📝 書評（任意）:
  <textarea id="review" rows="3"></textarea>
</label>

<button id="rescan">🔄 再スキャン</button>

<!-- ZXing & OpenCV 読み込み -->
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>

<script>
/* ---------- OpenCV 初期化フラグ ---------- */
let cvReady = false;
Module = { onRuntimeInitialized() { cvReady = true; console.log("✅ OpenCV ready"); } };

/* ---------- DOM / 変数 ---------- */
const ZX        = ZXing;
const videoEl   = document.getElementById("video");
const statusEl  = document.getElementById("status");
const infoBox   = document.getElementById("book-info");
const reviewEl  = document.getElementById("review");
const btnRescan = document.getElementById("rescan");

const reader = new ZX.BrowserMultiFormatReader({ delayBetweenScanAttempts: 250 }); // ← setHints を完全に削除

const offCanvas = document.createElement("canvas");
const offCtx    = offCanvas.getContext("2d");

let stream = null;
let scanning = false;
let lastISBN = null;

/* ---------- 検出時の処理 ---------- */
async function onDetect(isbn){
  console.log("✅ DETECT:", isbn);
  statusEl.textContent = "📚 書籍情報取得中…";

  const token = localStorage.getItem("notionToken");
  const dbid  = localStorage.getItem("notionDbId");
  const review= reviewEl.value.trim();

  try{
    const res = await fetch(`/add/${isbn}`,{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization':`Bearer ${token}`,
        'X-Database-ID':dbid
      },
      body: JSON.stringify({ review })
    });
    const data = await res.json();
    if(data.status==="OK"){
      infoBox.innerHTML = `
        ${data.cover ? `<img id="cover-img" src="${data.cover}" alt="書影">` : ""}
        <ul>
          <li><strong>📕 書名:</strong> ${data.title||"情報なし"}</li>
          <li><strong>✍️ 著者:</strong> ${data.author||"情報なし"}</li>
          <li><strong>🏢 出版社:</strong> ${data.publisher||"情報なし"}</li>
          <li><strong>💴 値段:</strong> ${data.price ? data.price+" 円":"情報なし"}</li>
          <li><strong>📅 出版日:</strong> ${data.pub_date||"情報なし"}</li>
          <li><strong>📄 ページ数:</strong> ${data.pages||"情報なし"}</li>
          <li><strong>📖 要約:</strong> ${data.summary||"情報なし"}</li>
        </ul>`;
      statusEl.textContent = "✅ 登録完了";
    }else{
      statusEl.textContent = "⚠️ " + data.message;
    }
  }catch(e){
    console.error(e);
    statusEl.textContent = "❌ 通信エラー";
  }

  btnRescan.style.display = "block";
}

/* ---------- フレーム毎の解析 ---------- */
function tick(){
  if(!scanning || !cvReady){ requestAnimationFrame(tick); return; }

  offCanvas.width  = videoEl.videoWidth;
  offCanvas.height = videoEl.videoHeight;
  offCtx.drawImage(videoEl, 0, 0, offCanvas.width, offCanvas.height);

  try{
    reader.decodeFromImage(offCanvas)
      .then(res=>{
        if(res && res.text && res.text !== lastISBN){
          lastISBN = res.text;
          onDetect(res.text);
        }
      })
      .catch(()=>{/* 読めないフレームは無視 */});
  }catch{/* noop */}

  requestAnimationFrame(tick);
}

/* ---------- カメラ起動 ---------- */
async function startCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  infoBox.innerHTML = ""; reviewEl.value=""; statusEl.textContent="📖 スキャン待機中…";
  btnRescan.style.display="none"; lastISBN=null;

  const constraints = { video:{ facingMode:{ideal:"environment"}, width:{ideal:1280} }, audio:false };
  try{
    stream = await navigator.mediaDevices.getUserMedia(constraints);
  }catch{
    constraints.video.facingMode = "user";
    stream = await navigator.mediaDevices.getUserMedia(constraints);
  }
  videoEl.srcObject = stream;
  await videoEl.play();

  scanning = true;
  requestAnimationFrame(tick);
}

/* ---------- イベント ---------- */
btnRescan.addEventListener("click", startCamera);
window.addEventListener("load", startCamera);
</script>
