<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>ISBNã‚¹ã‚­ãƒ£ãƒŠ</title>

<!-- PWA & ã‚¢ã‚¤ã‚³ãƒ³ -->
<link rel="manifest" href="/manifest.json" />
<link rel="icon" href="/static/isbn192.png" />
<meta name="theme-color" content="#000000" />

<style>
  body{
    margin:0;
    font-family:sans-serif;
    background:#000;
    color:#fff;
    display:flex;flex-direction:column;align-items:center
  }
  h1{margin:1rem 0 .5rem;font-size:2rem;color:#d8aaff}

  /* === Camera Area ===================================== */
  #video-wrapper{
    position:relative;
    width:90%;max-width:500px;height:220px;margin-top:1rem
  }
  video{
    width:100%;height:100%;object-fit:contain;
    border:3px solid #d8aaff;border-radius:12px
  }
  /* ROI æ  */
  #scan-frame{
    position:absolute;top:60px;left:25%;
    width:50%;height:120px;
    border:2px dashed #ff69b4;
    pointer-events:none
  }
  #scan-frame.flash{
    background:rgba(255,255,255,.25);
    transition:.4s
  }

  /* === Info / Controls ================================= */
  #status{margin-top:1rem;font-size:1.2rem;font-weight:bold;text-align:center}
  #book-info{margin-top:1rem;width:90%;max-width:600px;background:#111;
             border-radius:8px;padding:1rem}
  #cover-img{display:block;margin:0 auto 1rem;max-width:200px;border-radius:8px}
  #rescan{margin:1.5rem auto;padding:.6rem 1.4rem;border:none;border-radius:6px;
          background:#8b508d;color:#fff;font-size:1rem;display:none;cursor:pointer}
  textarea{width:90%;max-width:600px;margin-top:1rem;padding:.5rem;border-radius:6px}
</style>
</head>
<body>
<h1>ğŸ“· ISBN ã‚¹ã‚­ãƒ£ãƒŠ</h1>

<div id="video-wrapper">
  <video id="video" playsinline></video>
  <canvas id="off-canvas" style="display:none;"></canvas>
  <div id="scan-frame"></div>
</div>

<div id="status">ğŸ“– ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­â€¦</div>
<div id="book-info"></div>

<label style="width:90%;max-width:600px;display:block">
  ğŸ“ æ›¸è©•ï¼ˆä»»æ„ï¼‰:
  <textarea id="review" rows="3"></textarea>
</label>

<button id="rescan">ğŸ”„ å†ã‚¹ã‚­ãƒ£ãƒ³</button>

<!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>

<script>
/* ------ OpenCV readiness ------ */
let cvReady = false;
Module = { onRuntimeInitialized(){ cvReady = true; console.log("âœ… OpenCV ready"); } };

/* ------ DOM & ZXing ------ */
const ZX          = ZXing;
const videoEl     = document.getElementById("video");
const statusEl    = document.getElementById("status");
const infoBox     = document.getElementById("book-info");
const reviewEl    = document.getElementById("review");
const btnRescan   = document.getElementById("rescan");
const offCanvas   = document.getElementById("off-canvas");
const offCtx      = offCanvas.getContext("2d");

const reader = new ZX.BrowserMultiFormatReader({ delayBetweenScanAttempts: 250 });

let stream   = null;
let scanning = false;
let lastISBN = null;

/* ====== æ¤œå‡ºå¾Œã®å‡¦ç† ====== */
async function onDetect(isbn){
  console.log("âœ… DETECT:", isbn);
  statusEl.textContent = "ğŸ“š æ›¸ç±æƒ…å ±å–å¾—ä¸­â€¦";

  const token = localStorage.getItem("notionToken");
  const dbid  = localStorage.getItem("notionDbId");

  try{
    const res  = await fetch(`/add/${isbn}`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${token}`,
        "X-Database-ID":dbid
      },
      body: JSON.stringify({ review: reviewEl.value.trim() })
    });
    const data = await res.json();
    if(data.status==="OK"){
      infoBox.innerHTML = `
        ${data.cover ? `<img id="cover-img" src="${data.cover}" alt="æ›¸å½±">` : ""}
        <ul>
          <li><strong>ğŸ“• æ›¸å:</strong> ${data.title||"æƒ…å ±ãªã—"}</li>
          <li><strong>âœï¸ è‘—è€…:</strong> ${data.author||"æƒ…å ±ãªã—"}</li>
          <li><strong>ğŸ¢ å‡ºç‰ˆç¤¾:</strong> ${data.publisher||"æƒ…å ±ãªã—"}</li>
          <li><strong>ğŸ’´ å€¤æ®µ:</strong> ${data.price ? data.price+" å††":"æƒ…å ±ãªã—"}</li>
          <li><strong>ğŸ“… å‡ºç‰ˆæ—¥:</strong> ${data.pub_date||"æƒ…å ±ãªã—"}</li>
          <li><strong>ğŸ“„ ãƒšãƒ¼ã‚¸æ•°:</strong> ${data.pages||"æƒ…å ±ãªã—"}</li>
          <li><strong>ğŸ“– è¦ç´„:</strong> ${data.summary||"æƒ…å ±ãªã—"}</li>
        </ul>`;
      statusEl.textContent = "âœ… ç™»éŒ²å®Œäº†";
    }else{
      statusEl.textContent = "âš ï¸ " + data.message;
    }
  }catch(e){
    console.error(e);
    statusEl.textContent = "âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼";
  }
  btnRescan.style.display = "block";
}

/* ====== ãƒ•ãƒ¬ãƒ¼ãƒ æ¯ã®è§£æ ====== */
function tick(){
  if(!scanning){ requestAnimationFrame(tick); return; }

  // ZXing ãŒç›´æ¥èª­ã‚ã‚‹ã‹è©¦ã™
  reader.decodeOnceFromVideoElement(videoEl)
    .then(res=>{
      if(res && res.text !== lastISBN){
        lastISBN = res.text;
        flashFrame();
        onDetect(res.text);
      }
    })
    .catch(()=>{/* èª­ã‚ãªã„ãƒ•ãƒ¬ãƒ¼ãƒ ã¯ç„¡è¦– */});

  requestAnimationFrame(tick);
}

/* æ ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
function flashFrame(){
  const el = document.getElementById("scan-frame");
  el.classList.add("flash");
  setTimeout(()=>el.classList.remove("flash"), 350);
}

/* ====== ã‚«ãƒ¡ãƒ©èµ·å‹• ====== */
async function startCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  infoBox.innerHTML = ""; reviewEl.value="";
  statusEl.textContent = "ğŸ“– ã‚¹ã‚­ãƒ£ãƒ³å¾…æ©Ÿä¸­â€¦";
  btnRescan.style.display = "none"; lastISBN = null;

  const constraints = { video:{ facingMode:{ideal:"environment"}, width:{ideal:1280} }, audio:false };
  try{
    stream = await navigator.mediaDevices.getUserMedia(constraints);
  }catch{
    constraints.video.facingMode = "user";
    stream = await navigator.mediaDevices.getUserMedia(constraints);
  }
  videoEl.srcObject = stream;
  await videoEl.play();

  scanning = true;
  requestAnimationFrame(tick);
}

/* ====== ã‚¤ãƒ™ãƒ³ãƒˆ ====== */
btnRescan.addEventListener("click", startCamera);
window.addEventListener("load", startCamera);
</script>
</body>
</html>
